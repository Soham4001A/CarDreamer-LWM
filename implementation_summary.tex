\documentclass[11pt]{article}
\usepackage{amsmath,amssymb,amsfonts,booktabs,geometry,hyperref}
\usepackage{listings}
\geometry{margin=1in}
\newcommand{\code}[1]{\texttt{\detokenize{#1}}}

\begin{document}

{\LARGE \textbf{ArkAngel Implementation Summary (Final)}}

\section{Introduction}
This document summarizes the implementation of the ArkAngel architecture into the DreamerV3 model within the CarDreamer project, as per the instructions provided in \code{Instructions.tex}. The implementation includes the addition of new model heads for future prediction, auxiliary losses for training, and an inference patching mechanism to handle partial observability. This final summary reflects all the corrections and improvements made based on user feedback.

\section{File Changes}

\subsection{\code{dreamerv3/nets.py}}
The \code{LatentActor} was corrected to return a raw feature vector instead of a distribution.

\begin{lstlisting}[language=Python]
class LatentActor(nj.Module):
    def __init__(self, deter_size, stoch_size, classes, mlp_layers=4, mlp_units=512, **kw):
        self._deter_size = deter_size
        self._stoch_size = stoch_size
        self._classes = classes
        self._kw = kw
        self._mlp = MLP(
            shape=None, layers=mlp_layers, units=mlp_units, name="la_mlp", **self._kw
        )
        out_dim = self._deter_size + self._stoch_size * (self._classes or 1)
        self._out = Linear(out_dim, **{k: v for k, v in self._kw.items() if k != "name"})

    def __call__(self, h, z, a):
        if self._classes:
            z = z.reshape(z.shape[:-2] + (self._stoch_size * self._classes,))
        if len(a.shape) > len(h.shape):
            a = a.reshape(a.shape[:-2] + (int(np.prod(a.shape[-2:])),))
        x = jnp.concatenate([h, z, a], -1)
        x = self._mlp(x)
        x = self._out(x)
        h_hat, z_flat = jnp.split(x, [self._deter_size], -1)
        if self._classes:
            z_hat = z_flat.reshape(z_flat.shape[:-1] + (self._stoch_size, self._classes))
        else:
            z_hat = z_flat
        return h_hat, z_hat
\end{lstlisting}

\subsection{\code{dreamerv3/agent.py}}
This file was modified to integrate the new ArkAngel modules into the agent's lifecycle, including training and policy execution.

\subsubsection{WorldModel Modifications}
\begin{itemize}
    \item In \code{WorldModel.__init__}, the \code{recon_key} is now correctly read from the config.
    \item In \code{WorldModel.loss}, the loss for the discrete latent variable $z$ in $L_{LA}$ was corrected to use KL divergence.
\end{itemize}

\subsubsection{Agent Modifications}
\begin{itemize}
    \item In \code{Agent.policy}, the stray call to \code{self.expl_behavior.policy} was removed. The blackout detection is now batch-wise, and the patching logic uses safer broadcasting and correct data types.
\end{itemize}

\subsection{\code{car_dreamer/toolkit/observer/utils.py}}
This file was modified to register the new \code{MaskHandler}.

\subsection{\code{run_dm3_sweep.sh}}
This shell script was updated to include a \code{DRY_RUN} flag, a sweep over observability modes, a \code{RUN_EVAL} flag, and quoted list arguments.

\section{New Files Created}

\subsection{\code{car_dreamer/toolkit/observer/handlers/mask_handler.py}}
This file contains the \code{MaskHandler} class, which is responsible for generating a binary mask representing the agent's field of view.
\begin{lstlisting}[language=Python]
# TODO: Improve mask geometry to account for ego yaw and sight range.
import numpy as np
from .base_handler import BaseHandler

class MaskHandler(BaseHandler):
    # ... (rest of the code)
\end{lstlisting}

\end{document}